Run started at: Mon Apr  7 00:36:27 PDT 2025
Parameters: detection-model=XGB, localization-model=TF, target-spec=99
-------------------------------------------------
Using target specificity: 0.990
Loading supplemental data...
Processing patient information...

Debug - Clinical df columns: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)', 'Plasma_DNA_concentration', 'CancerSEEK_Logistic_Regression_Score', 'CancerSEEK_Test_Result']

Debug - Mutations df columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'Plasma_volume_(mL)', 'Plasma_DNA_concentration', 'Mutation_identified_in_plasma', 'omega_score', 'Mutant_AF', 'per_mL_plasma'] ...

Debug - Protein df columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3', 'CA19-9'] ...
Extracting protein measurements...

Debug - Number of protein columns: 39
Debug - First few protein columns: ['AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3']

Debug - Shape after merging protein data: (1817, 53)
Debug - Data df columns after protein merge: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)'] ...
Checking for omega_score...

Debug - Found omega_score in mutations_df. Shape: (1817, 3)

Debug - Final data shape: (1817, 54)
Debug - First few columns: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)']
Handling missing values...

Debug - Feature columns: ['Age', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125'] ...
Debug - Number of feature columns: 41

Debug - X shape: (1817, 45)
Debug - X columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'Age', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3'] ...

==== Starting model training and evaluation ====
Training combined cancer detection (XGB) and localization (TF) model with 1817 samples
Using 8 protein features for detection model
Performing 10-fold outer CV and 4-fold inner CV
Standardization: False, Log transformation: none

=== PHASE 1: Cancer Detection Model (XGB) ===
Starting nested cross-validation for cancer detection using XGB...
Creating stratified folds based on clinical data...
Warning: Not enough valid folds from clinical data, falling back to StratifiedKFold.
XGB cancer detection CV folds:   0%|          | 0/10 [00:00<?, ?it/s]Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
XGB cancer detection CV folds:  10%|█         | 1/10 [00:04<00:37,  4.19s/it]XGB cancer detection CV folds:  20%|██        | 2/10 [00:07<00:27,  3.40s/it]XGB cancer detection CV folds:  30%|███       | 3/10 [00:09<00:22,  3.18s/it]XGB cancer detection CV folds:  40%|████      | 4/10 [00:12<00:18,  3.06s/it]XGB cancer detection CV folds:  50%|█████     | 5/10 [00:15<00:14,  2.97s/it]XGB cancer detection CV folds:  60%|██████    | 6/10 [00:18<00:11,  2.94s/it]XGB cancer detection CV folds:  70%|███████   | 7/10 [00:21<00:08,  2.91s/it]XGB cancer detection CV folds:  80%|████████  | 8/10 [00:24<00:05,  2.89s/it]XGB cancer detection CV folds:  90%|█████████ | 9/10 [00:27<00:02,  2.89s/it]XGB cancer detection CV folds: 100%|██████████| 10/10 [00:30<00:00,  2.91s/it]XGB cancer detection CV folds: 100%|██████████| 10/10 [00:30<00:00,  3.01s/it]
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Completed cancer detection model with overall AUC: 0.8423

Detected 634 cancer samples out of 1005 true cancer samples

=== PHASE 2: Tissue Localization Model (TF) ===
Starting nested cross-validation for TensorFlow fusion model...
Multi-class classification with 8 classes
Creating stratified folds based on clinical data...
Warning: Not enough valid folds from clinical data, falling back to StratifiedKFold.
TF fusion model CV folds:   0%|          | 0/10 [00:00<?, ?it/s]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  10%|█         | 1/10 [00:09<01:25,  9.52s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  20%|██        | 2/10 [00:11<00:42,  5.30s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  30%|███       | 3/10 [00:14<00:27,  3.96s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  40%|████      | 4/10 [00:16<00:20,  3.37s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
WARNING:tensorflow:5 out of the last 9 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x373bbaac0> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:6 out of the last 10 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x373bbaac0> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
TF fusion model CV folds:  50%|█████     | 5/10 [00:19<00:15,  3.00s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  60%|██████    | 6/10 [00:21<00:10,  2.65s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  70%|███████   | 7/10 [00:23<00:07,  2.55s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  80%|████████  | 8/10 [00:25<00:04,  2.47s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
TF fusion model CV folds:  80%|████████  | 8/10 [00:27<00:06,  3.40s/it]
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Trying lr=0.001, batch_size=16, epochs=50
Trying lr=0.001, batch_size=16, epochs=100
Trying lr=0.001, batch_size=32, epochs=50
Trying lr=0.001, batch_size=32, epochs=100
Trying lr=0.001, batch_size=64, epochs=50
Trying lr=0.001, batch_size=64, epochs=100
Trying lr=0.01, batch_size=16, epochs=50
Trying lr=0.01, batch_size=16, epochs=100
Trying lr=0.01, batch_size=32, epochs=50
Trying lr=0.01, batch_size=32, epochs=100
Trying lr=0.01, batch_size=64, epochs=50
Trying lr=0.01, batch_size=64, epochs=100
Best parameters: {'lr': 0.01, 'batch_size': 16, 'epochs': 50}
Fold 0: Retraining with best parameters: {'lr': 0.01, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 1: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 2: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 3: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 4: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 5: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 6: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 7: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 8: Retraining with best parameters: {'lr': 0.001, 'batch_size': 32, 'epochs': 50}
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3805, in get_loc
    return self._engine.get_loc(casted_key)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 2606, in pandas._libs.hashtable.Int64HashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 2630, in pandas._libs.hashtable.Int64HashTable.get_item
KeyError: 0

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/alvinshi/Library/CloudStorage/Dropbox/Interview_prep/Exact_Sciences/CancerSEEK/paper_reproduction.py", line 190, in <module>
    combined_results = models.combined_cancer_detection_and_localization(
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/alvinshi/Library/CloudStorage/Dropbox/Interview_prep/Exact_Sciences/CancerSEEK/models.py", line 1237, in combined_cancer_detection_and_localization
    rf_results = nested_cross_validation_tf(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/alvinshi/Library/CloudStorage/Dropbox/Interview_prep/Exact_Sciences/CancerSEEK/models.py", line 1919, in nested_cross_validation_tf
    final_model.fit(
  File "/Users/alvinshi/Library/CloudStorage/Dropbox/Interview_prep/Exact_Sciences/CancerSEEK/models.py", line 1494, in fit
    if isinstance(y[0], str):
                  ~^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/pandas/core/series.py", line 1121, in __getitem__
    return self._get_value(key)
           ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/pandas/core/series.py", line 1237, in _get_value
    loc = self.index.get_loc(label)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3812, in get_loc
    raise KeyError(key) from err
KeyError: 0
