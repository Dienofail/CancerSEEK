Run started at: Mon Apr  7 04:04:51 PDT 2025
Parameters: detection-model=MOE, localization-model=MOE, target-spec=985
-------------------------------------------------
Using target specificity: 0.985
Loading supplemental data...
Processing patient information...

Debug - Clinical df columns: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)', 'Plasma_DNA_concentration', 'CancerSEEK_Logistic_Regression_Score', 'CancerSEEK_Test_Result']

Debug - Mutations df columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'Plasma_volume_(mL)', 'Plasma_DNA_concentration', 'Mutation_identified_in_plasma', 'omega_score', 'Mutant_AF', 'per_mL_plasma'] ...

Debug - Protein df columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3', 'CA19-9'] ...
Extracting protein measurements...

Debug - Number of protein columns: 39
Debug - First few protein columns: ['AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3']

Debug - Shape after merging protein data: (1817, 53)
Debug - Data df columns after protein merge: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)'] ...
Checking for omega_score...

Debug - Found omega_score in mutations_df. Shape: (1817, 3)

Debug - Final data shape: (1817, 54)
Debug - First few columns: ['Patient_ID', 'Sample_ID', 'Primary_tumor_sample_ID', 'Age', 'Sex', 'Race', 'Tumor_type', 'AJCC_Stage', 'Histopathology', 'Plasma_volume_(mL)']
Handling missing values...

Debug - Feature columns: ['Age', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125'] ...
Debug - Number of feature columns: 41

Debug - X shape: (1817, 45)
Debug - X columns: ['Patient_ID', 'Sample_ID', 'Tumor_type', 'AJCC_Stage', 'Age', 'AFP', 'Angiopoietin-2', 'AXL', 'CA-125', 'CA_15-3'] ...

==== Starting model training and evaluation ====
Training combined cancer detection (MOE) and localization (MOE) model with 1817 samples
Using 8 protein features for detection model
Performing 10-fold outer CV and 4-fold inner CV
Standardization: False, Log transformation: none

=== PHASE 1: Cancer Detection Model (MOE) ===
Starting nested cross-validation for Mixture of Experts model...
Binary classification
Creating stratified folds based on clinical data...
Warning: Not enough valid folds from clinical data, falling back to StratifiedKFold.
MOE model CV folds:   0%|          | 0/10 [00:00<?, ?it/s]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  10%|█         | 1/10 [01:11<10:40, 71.15s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  20%|██        | 2/10 [02:24<09:39, 72.40s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  30%|███       | 3/10 [03:45<08:53, 76.22s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  40%|████      | 4/10 [04:57<07:29, 74.87s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  50%|█████     | 5/10 [06:11<06:11, 74.39s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  60%|██████    | 6/10 [07:25<04:56, 74.22s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  70%|███████   | 7/10 [08:39<03:42, 74.22s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  80%|████████  | 8/10 [09:53<02:28, 74.10s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  90%|█████████ | 9/10 [11:03<01:12, 72.79s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds: 100%|██████████| 10/10 [12:18<00:00, 73.57s/it]MOE model CV folds: 100%|██████████| 10/10 [12:18<00:00, 73.87s/it]
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 0: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 1: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 2: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 100}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 3: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 4: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 5: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 6: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 7: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 8: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 9: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Completed MOE model with overall AUC: 0.8424

Detected 591 cancer samples out of 1005 true cancer samples

=== PHASE 2: Tissue Localization Model (MOE) ===
Starting nested cross-validation for Mixture of Experts model...
Multi-class classification with 8 classes
Creating stratified folds based on clinical data...
Warning: Not enough valid folds from clinical data, falling back to StratifiedKFold.
MOE model CV folds:   0%|          | 0/10 [00:00<?, ?it/s]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  10%|█         | 1/10 [00:58<08:42, 58.04s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
WARNING:tensorflow:5 out of the last 15 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x6746e8180> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
WARNING:tensorflow:5 out of the last 11 calls to <function TensorFlowTrainer.make_predict_function.<locals>.one_step_on_data_distributed at 0x6746e8180> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
MOE model CV folds:  20%|██        | 2/10 [02:04<08:22, 62.83s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  30%|███       | 3/10 [03:03<07:07, 61.11s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  40%|████      | 4/10 [04:14<06:30, 65.02s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  50%|█████     | 5/10 [05:14<05:16, 63.26s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  60%|██████    | 6/10 [06:16<04:11, 62.84s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  70%|███████   | 7/10 [07:31<03:20, 66.78s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  80%|████████  | 8/10 [08:33<02:10, 65.25s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds:  90%|█████████ | 9/10 [09:35<01:04, 64.40s/it]/opt/anaconda3/lib/python3.12/site-packages/keras/src/models/functional.py:225: UserWarning: The structure of `inputs` doesn't match the expected structure: ['protein_input', 'omega_input']. Received: the structure of inputs=('*', '*')
  warnings.warn(
MOE model CV folds: 100%|██████████| 10/10 [10:39<00:00, 64.10s/it]MOE model CV folds: 100%|██████████| 10/10 [10:39<00:00, 63.93s/it]
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 0: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 1: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 2: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 3: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 4: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 5: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 6: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 7: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 8: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in protein dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Warning: 'Patient_ID' column not found in mutation dataframe. Using training_indices directly.
Fold 9: Retraining with best parameters: {'lr': 0.001, 'batch_size': 16, 'epochs': 50}
Completed MOE model with overall accuracy: 0.2115

=== Combining results from both models ===
Final results: Detection accuracy: 0.7666, Localization accuracy: 0.2115

==== Model training complete ====
Generating plots...

==== Debugging localization_results ====
Type of combined_results: <class 'dict'>
Type of localization_results: <class 'dict'>
Keys in localization_results: dict_keys(['fold_results', 'overall_accuracy', 'predictions'])
Type of predictions: <class 'numpy.ndarray'>
Shape of predictions: (591,)
predictions is a numpy array, not a DataFrame/Series with an index
Saved ROC curve to plots/roc_curve_MOE_985.pdf
Saved ROC curve data to plots/roc_curve_data_MOE_985.pkl
Saved sensitivity by subtype to plots/sensitivity_by_subtype_MOE_985.pdf
Saved sensitivity by stage to plots/sensitivity_by_stage_MOE_985.pdf
Saved performance summary to plots/performance_summary_MOE_985.csv
Processing tissue localization results...

==== Debug: Tissue localization data ====
Number of positive indices: 594
Max positive index: 1816
Predictions array length: 591
Predictions array type: <class 'numpy.ndarray'>
First few values in predictions: ['Colorectum' 'Stomach' 'Liver' 'Liver' 'Colorectum']
Saved tissue localization accuracy to plots/tissue_localization_accuracy_MOE_MOE.pdf
Number of samples: 331
Cancer types for matrix: ['Colorectum', 'Lung', 'Breast', 'Pancreas', 'Ovary', 'Esophagus', 'Liver', 'Stomach']
Saved tissue localization confusion matrix to plots/tissue_localization_confusion_matrix_MOE_MOE.pdf
Localization metrics: Accuracy=0.175, Macro-F1=0.103, Micro-F1=0.175

==== All processing complete ====
